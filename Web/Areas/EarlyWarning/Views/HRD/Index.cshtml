@using Cats.Security
@using Cats.Services.Security
@using Kendo.Mvc.UI
@using Cats.Helpers
@using Cats.Models
@using Cats.Models.ViewModels.HRD

@using LanguageHelpers.Localization

@model List<Cats.Models.ViewModels.HRD.HRDViewModel>

@{
    var index = 0;
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/NewTheme _MainLayout.cshtml";
    ViewBag.PageTitle = Html.Translate("Humanitarian Requirement Document");
    ViewBag.PageTitleDescription = "";

}

<div class="row">
    @Html.Partial("_HRDLeftBar")
    <div class="col-md-9">
        <div class="portlet light bordered">
            <div class="portlet-title">
                <div class="caption font-green-sharp">
                    <i class="icon-list font-green-sharp"></i>
                    <span class="caption-subject bold uppercase"> @Html.Translate("HRD Lists")</span>
                </div>
                <div class="tools">
                    <a href="#" class="collapse" data-original-title="" title=""></a>
                </div>
                <div class="actions">
                    @Html.EarlyWarningOperationButton(
                        @Url.Action("Create", "HRD", new { Area = "EarlyWarning" }),
                        EarlyWarningConstants.Operation.New_HRD, "<button type=\"button\" class=\"btn green btn-sm\"><span class=\"fa fa-plus\"></span> New HRD</button>", "btn", "btn_new_record")
                    <a class="btn btn-icon-only btn-default fullscreen"></a>
                </div>
            </div>
            <div class="portlet-body">
                <div class="table-responsive" style="overflow-x: visible !important;">
                    <table class="table table-striped table-condensed">
                        <thead>
                            <tr>
                                <th>HRD Name</th>
                                <th>Ration No</th>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Created By</th>
                                <th>Date Created</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (HRDViewModel item in Model)
                            {
                                index++;
                                var currentState = item.BusinessProcess.CurrentState;
                                var state = currentState != null ? currentState.BaseStateTemplate : null;
                                <tr>
                                    <td>
                                        <a href='@Url.Action("Detail", "HRD", new {id = item.HRDID})'> @item.Plan </a>
                                    </td>
                                    <td>
                                        @item.Ration
                                    </td>
                                    <td>
                                        @item.StartDate
                                    </td>
                                    <td>
                                        @item.EndDate
                                    </td>
                                    <td>
                                        @item.CreatedBy
                                    </td>
                                    <td>
                                        @item.CreatedDatePref
                                    </td>
                                    <td>
                                        @item.Status
                                    </td>
                                    <td>
                                        @if (UserAccountHelper.EarlyWarningPsnpOperationCheck(EarlyWarningConstants.Operation.Modify_HRD))
                                        {
                                            <a href='@Url.Action("Edit", "HRD", new {id = item.HRDID})' class="btn btn-xs btn-default yellow-lemon-stripe">
                                                @*<span class="glyphicon glyphicon-edit"></span>*@
                                                Edit
                                            </a>
                                        }
                                       
                                        @if (UserAccountHelper.EarlyWarningPsnpOperationCheck(EarlyWarningConstants.Operation.HRD_Summary))
                                        {
                                            <a href='@Url.Action("RegionalSummary", "HRD", new {id = item.HRDID})' class="btn btn-xs btn-default blue-stripe">
                                                @*<span class="glyphicon glyphicon-list-alt" aria-hidden="true"></span>*@
                                                Summary
                                            </a>
                                        }
                                       
                                        <div class="btn-group">
                                            <button type="button" id="action_@index" class="btn btn-default dropdown-toggle btn-xs green-stripe" data-toggle="dropdown">
                                                <i class="fa fa-ellipsis-horizontal"></i> @Html.Translate("Workflow") <i class="fa fa-angle-down"></i>
                                            </button>

                                            <ul class="dropdown-menu pull-right">
                                                @foreach (FlowTemplate actions in state.InitialStateFlowTemplates)
                                                {
                                                    if (UserAccountHelper.EarlyWarningPsnpOperationCheck(EarlyWarningConstants.Operation.Approve_HRD) && actions.Name == "Approve")
                                                    {
                                                        <li class="edit_button">
                                                            <a href="javascript:promot_workflow(@item.BusinessProcessID ,@actions.FinalStateID,'@actions.Name',@item.HRDID)" title="@actions.Name">@actions.Name</a>
                                                        </li>
                                                    }
                                                    if (UserAccountHelper.EarlyWarningPsnpOperationCheck(EarlyWarningConstants.Operation.Delete_HRD) && actions.Name == "Delete")
                                                    {
                                                        <li class="edit_button">
                                                            <a href="javascript:promot_workflow(@item.BusinessProcessID ,@actions.FinalStateID,'@actions.Name',@item.HRDID)" title="@actions.Name">@actions.Name</a>
                                                        </li>
                                                    }
                                                }
                                                <li class="divider"></li>
                                                @if (UserAccountHelper.EarlyWarningPsnpOperationCheck(EarlyWarningConstants.Operation.View_HRD_Detail))
                                                {
                                                    <li class="edit_button"><a href="javascript:workflow_history(@item.BusinessProcessID)"> History </a></li>
                                                }
                                            </ul>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="cats-modal">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">

            <div class="modal-header">
                <button aria-hidden="true" data-dismiss="modal" class="close" type="button">×</button>
                <h4 id="myModalLabel" class="modal-title">@Html.Translate("Approve Gift Certificate")</h4>
            </div>


            <div class="modal-body">

                <p>
                    Are you sure do you want to approve HRD?
                </p>

            </div>
            <div class="modal-footer">
                <button id="yes" class="btn btn-primary" type="submit">Yes</button>
                <button id="no"class="btn" data-dismiss="modal" aria-hidden="true">No</button>
            </div>


        </div>
    </div>
</div>

<div class="modal" id="cats-modal-delete">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">

            <div class="modal-header">
                <button aria-hidden="true" data-dismiss="modal" class="close" type="button">×</button>
                <h4 id="myModalLabel" class="modal-title">@Html.Translate("Delete HRD")</h4>
            </div>


            <div class="modal-body">

                <p>
                    Are you sure do you want to delete the HRD?
                </p>

            </div>
            <div class="modal-footer">
                <button id="yes-delete" class="btn btn-primary" type="submit">Yes</button>
                <button id="no" class="btn" data-dismiss="modal" aria-hidden="true">No</button>
            </div>


        </div>
    </div>
</div>

<div id="modalHistory" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                <h4 id="modalHistoryLabel">Activity History</h4>
            </div>
            <div class="modal-body" id="modalHistoryBody">History</div>

        </div>
    </div>
</div>
    @Html.Partial("~/Views/Shared/_PromotWorkflow.cshtml");
<script>
    function onDataBound(e) {

        $(".table-responsive .k-button").removeClass("k-button").addClass("btn btn-xs mrgn3-b col-md-11");
        $(".k-grid-Edit").addClass("btn-warning");
        $(".k-grid-Approve").addClass("btn-success");
        $(".k-grid-Summary").addClass("btn-primary");
        $(".k-grid-Delete").addClass("btn-danger");
    }

    function approveHRD(e) {
        e.preventDefault();
        var grid = this;
        var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
        var row = $(e.currentTarget).closest("tr");
        $('#cats-modal').modal('show');

        $("#yes").click(function () {

            window.location = "@Url.Action("ApproveHRD", "HRD")" + "/" + dataItem.HRDID;

        });
    }

    //Added by Nigus
    function deleteHRD(e) {
        e.preventDefault();
        var grid = this;
        var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
        var row = $(e.currentTarget).closest("tr");
        $('#cats-modal-delete').modal('show');

        $("#yes-delete").click(function () {

            window.location = "@Url.Action("DeleteHRD", "HRD")" + "/" + dataItem.HRDID;

        });
    }

    function showSummary(e) {
        e.preventDefault();
        var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
        window.location = "@Url.Action("RegionalSummary", "HRD")" + "/" + dataItem.HRDID;
    }

    function hrdEdit(e) {
        e.preventDefault();

        var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
        window.location = "@Url.Action("Edit", "HRD")" + "/" + dataItem.HRDID;

    }


    var myApp = angular.module('hrdApp', []);

    myApp.controller('HrdController', function ($scope, $http) {
        $scope.hrds = [];
        $scope.onRequestsSuccess = function (data) {
            $scope.hrds = data;

        };


        $scope.getHrd = function () {
            $http.post("@Url.Action("HRD_Read", "HRD", new {Area = "EarlyWarning"})").success(onRequestsSuccess);
        };

        //$scope.getHrd();
    });
</script>

<script type="text/javascript">
    function error_handler(e) {
        if (e.errors) {
            var message = "Errors:\n";
            $.each(e.errors, function (key, value) {
                if ('errors' in value) {
                    $.each(value.errors, function () {
                        message += this + "\n";
                    });
                }
            });
            alert(message);
        }
    }
</script>
<script>
    // Workflow Implementation
    var history_link = "@Url.Action("History", "BusinessProcess", new { Area = "WorkflowManager", id = "0" })";

    function promot_workflow(BusinessProcessID, nextstate, actionname, PlanID) {
        //alert(PaymentRequestID);
        $('#ParentBusinessProcessID').val(BusinessProcessID);
        $('#stateID').val(nextstate);
        $('#modalPromotionLabel').html(actionname);
        $('#TransporterChequeID').val(TransporterChequeID);
        $('#modalPromotion').modal();
        $.ajax({
            type: "POST",
            url: "@Url.Action("ApproveHRD", "HRD")",
            data: "{id:" + PlanID + "}",
            dataType: json
        });
    }

    function workflow_history(BusinessProcessID) {
        $('#modalHistory').modal();
        $('#modalHistoryBody').html("<div style='text-align:center;'> <img src='/content/images/loading.gif'/></div>");
        $.post(history_link + BusinessProcessID, {},
            function (data) {
                $("#modalHistoryBody").html(data);
            }
        );
    }

</script>